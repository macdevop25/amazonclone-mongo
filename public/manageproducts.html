<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products (Admin)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
        }

        .table-responsive {
            max-width: 100%;
            overflow-x: auto;
        }
    </style>
</head>

<body class="bg-light text-dark">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Admin Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="addproduct.html">Add Product</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="manageproducts.html">Manage Products</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4 text-center">Manage Products</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">Image</th>
                        <th scope="col">Title</th>
                        <th scope="col">Price</th>
                        <th scope="col">Category</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                </tbody>
            </table>
        </div>
        <div id="loading" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading products...</p>
        </div>
    </div>
<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editProductForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editProductId">
          <div class="mb-3">
            <label>Title</label>
            <input type="text" name="title" id="editProductTitle" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Price</label>
            <input type="number" step="0.01" name="price" id="editProductPrice" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Category</label>
            <select name="category" id="editProductCategory" class="form-select" required></select>
          </div>
          <div class="mb-3">
            <label>Image</label>
            <input type="file" name="image" id="editProductImage" class="form-control">
            <small class="text-muted">Leave empty to keep current image</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update Product</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', async () => {
    const productTableBody = document.getElementById('productTableBody');
    const loadingSpinner = document.getElementById('loading');

    const fetchProducts = async () => {
        loadingSpinner.style.display = 'block';
        productTableBody.innerHTML = '';
        try {
            const res = await fetch('/api/admin/products');
            let data;
            try {
                data = await res.json(); // parse JSON
            } catch(err) {
                console.error('Failed to parse JSON:', await res.text());
                productTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Server error: expected JSON.</td></tr>';
                return;
            }

            if (res.ok) {
                if (data.products.length > 0) {
                    data.products.forEach(product => {
                        const row = `
                        <tr>
                            <td><img src="${product.image.startsWith('uploads') ? '/' + product.image : product.image}" alt="${product.title}" class="product-image rounded"></td>
                            <td>${product.title}</td>
                            <td>â‚¹${product.price.toFixed(2)}</td>
                            <td>${product.category || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-id="${product._id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${product._id}">Delete</button>
                            </td>
                        </tr>
                        `;
                        productTableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    productTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No products found.</td></tr>';
                }
            } else {
                productTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${data.message}</td></tr>`;
            }
        } catch (err) {
            console.error('Fetch error:', err);
            productTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to connect to the server.</td></tr>';
        } finally {
            loadingSpinner.style.display = 'none';
        }
    };

    fetchProducts();

    // Delete button listener
    productTableBody.addEventListener('click', async (e) => {
        const button = e.target;
        const productId = button.dataset.id;

        if (button.classList.contains('delete-btn')) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const res = await fetch(`/api/admin/delete-product/${productId}`, { method: 'DELETE' });
                    const result = await res.json();
                    if (res.ok) {
                        alert(result.message);
                        fetchProducts();
                    } else {
                        alert(result.message || 'Failed to delete product.');
                    }
                } catch (err) {
                    console.error('Delete error:', err);
                    alert('An error occurred while trying to delete the product.');
                }
            }
        }
    });

    // === EDIT MODAL LOGIC ===
    const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
    const editForm = document.getElementById('editProductForm');
    const categorySelect = document.getElementById('editProductCategory');

    productTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const id = e.target.dataset.id;
            try {
                const res = await fetch(`/api/admin/product/${id}`);
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('editProductId').value = data.product._id;
                    document.getElementById('editProductTitle').value = data.product.title;
                    document.getElementById('editProductPrice').value = data.product.price;

                 // Define available categories (same as Add Product)
const categories = ["Electronics", "Accessories", "Gaming", "Storage"];

// Populate category dropdown
categorySelect.innerHTML = '<option value="">Select Category</option>';

categories.forEach(cat => {
    const selected = (data.product.category === cat) ? 'selected' : '';
    categorySelect.insertAdjacentHTML(
        'beforeend',
        `<option value="${cat}" ${selected}>${cat}</option>`
    );
});

                    editModal.show();
                } else {
                    alert(data.message || 'Failed to fetch product details.');
                }
            } catch(err) {
                console.error('Edit fetch error:', err);
                alert('Error fetching product data.');
            }
        }
    });

    // Handle edit form submission
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(editForm);
        const id = formData.get('id');
        try {
            const res = await fetch(`/api/admin/update-product/${id}`, {
                method: 'PUT',
                body: formData
            });
            const result = await res.json();
            if (res.ok) {
                alert(result.message);
                editModal.hide();
                fetchProducts();
            } else {
                alert(result.message || 'Failed to update product.');
            }
        } catch(err) {
            console.error('Update error:', err);
            alert('Error updating product.');
        }
    });

});
</script>

</body>

</html>